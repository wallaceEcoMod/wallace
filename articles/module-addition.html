<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="wallace">
<title>How to write a module in Wallace • wallace</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to write a module in Wallace">
<meta property="og:description" content="wallace">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">wallace</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/tutorial-v2.html">Tutorial Vignette v2</a>
    <a class="dropdown-item" href="../articles/tutorial-v2-esp.html">Tutorial Vignette v2 (ESP)</a>
    <a class="dropdown-item" href="../articles/module-addition.html">Module addition</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Archive</h6>
    <a class="dropdown-item" href="../articles/tutorial-v1.html">Tutorial Vignette v1</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to write a module in Wallace</h1>
                        <h4 data-toc-skip class="author">Gonzalo
Pinilla-Buitrago, Jamie M. Kass, Siew Fong Chen, Peter Galante, Bethany
A. Johnson, Dean Attali</h4>
            
            <h4 data-toc-skip class="date">April 19, 2022</h4>
      
      
      <div class="d-none name"><code>module-addition.Rmd</code></div>
    </div>

    
    
<p><em>Wallace</em> is an <code>R</code>-based, interactive application
for reproducible ecological modeling, currently focusing on species
distribution modeling. The application is composed of sequential steps
of analysis called “components”, and methodological options within each
component called “modules”. A key feature is that the application is
expandible via the addition of new modules. This vignette guides users
through the module authorship process, explaining the steps involved in
adding a module, best practices to follow, and occasional
troubleshooting. This vignette primarily targets researchers who want to
author their own <em>Wallace</em> module that performs some additional
analysis either for their own use or for others to use within the
<em>Wallace</em> workflow. To follow along, it will help to have at
least an intermediate understanding of <code>R</code> programming. Also,
please see our
<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12945" target="_blank" class="external-link">publication</a>
in <em>Methods in Ecology and Evolution</em> to read in detail about our
philosophy for <em>Wallace</em>, the modularity of the application, and
our vision for module authorship.</p>
<p><em>Wallace</em> was built using an R package for developing graphic
user interface applications called <code>shiny</code>, and the modules
in <em>Wallace</em> are structured as <code>shiny</code> modules. Before
proceeding, it is advisable to read through the
<a href="https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/" target="_blank" class="external-link">tutorial</a>
on <code>shiny</code> to give you a firm foundation of the basics. This
<a href="https://shiny.rstudio.com/articles/modules.html" target="_blank" class="external-link">instructional
page</a> on <code>shiny</code> modules is also very helpful. For further
reading, there are many more <code>shiny</code> informational resources
<a href="https://shiny.rstudio.com/tutorial/" target="_blank" class="external-link">here</a>
as well.</p>
<div class="section level2">
<h2 id="wallace-package-structure">
<em>Wallace</em> package structure<a class="anchor" aria-label="anchor" href="#wallace-package-structure"></a>
</h2>
<p>First, we will give a brief overview of the file structure of the
<code>wallace</code> package. The starred directories and files are the
ones we will be concentrating on in this vignette. Particular focus will
be on the two main scripts <code>ui.R</code> and <code>server.R</code>.
The <code>ui.R</code> file controls the layout and appearance of the
application, while the <code>server.R</code> file contains the
instructions needed to build the application. Also of note is the script
that includes helper functions, and the directories for modules
(<code>/inst/shiny/modules</code>), module functions (<code>/R</code>),
and component guidance text (<code>/inst/shiny/Rmd</code>).</p>
<pre><code>/wallace    
---DESCRIPTION                          # Package description
---NAMESPACE                            # File with functions names
---NEWS.md                              # Release news of each version
---README.md                            # Information about package
---wallace.Rproj                        # R project file -- when developing, load wallace with this
+---/inst
    +---/extdata                        # Folder with example data
    +---/module_skeleton                # Folder to create template of module (do not modify)
    +---/shiny                          # Folder with files of the graphic interface
        ---global.R                     # File for module loading (do not modify)
        ---helpers.R                    # Helper functions not specific to any one module
        ---server.R                     # Script with all functionality for processing
        ---ui.R                         # Script with all functionality for user interface
        +---/custom_modules             # Folder that host files of new module
            ---penvs_correlation.md     # Guidance text file
            ---penvs_correlation.R      # File with core module functionality
            ---penvs_correlation.Rmd    # File with code to add to the session code (optional)
            ---penvs_correlation.yml    # YML file for calling the module internally
        +---/modules                    # Folder with files of modules already integrated in the interface
        +---/Rmd                        # Folder with component guidance text and files to create session code
        +---/www                        # Folder with images and css to include in the interface
+---/man                                # Folder with function documentations
+---/R                                  # Folder with package R functions. Your R function should be saved here
    ---custom_modules.R                 # Function to create module template
    ---helper_functions.R               # Collection of function for internal Wallace functionality.
    ---run_wallace.R                    # Funtion to open interface
    ---wallace-package.R                # Information about package
    ---penvs_correlation.R              # Function that will create in this vignette
    --- …                               # More R function for each module
+---/tests                              # Unit test scripts and data
+---/vignettes                          # RMD files for vignettes</code></pre>
</div>
<div class="section level2">
<h2 id="wallace-data-structure">
<em>Wallace</em> data structure<a class="anchor" aria-label="anchor" href="#wallace-data-structure"></a>
</h2>
<p>Before moving forward, we should go over some important points about
the structure of the data that <em>Wallace</em> stores. All data
specific to the species is recorded in a <em>reactive list</em> called
<code>spp</code>. In <code>shiny</code>, reactive objects are dynamic
entities that update whenever the user makes a change using the
<code>shiny</code> interface (i.e., pushes a button, selects a value).
Thus, <code>spp</code> will update depending on what species is
currently selected by the user. Since Wallace can now handle analyses of
multiple species, the reactive function <code>curSp()</code> simply
returns the name of the species currently selected in <em>Wallace</em>,
and so <code>spp[[curSp()]]</code> will index <code>spp</code> to return
data on the selected species. And since <code>spp</code> updates are
based on user input, it is necessary to use a reactive function to
retrieve the species name. By running <code>spp[[curSp()]]</code>, we
can see a list of data objects for the selected species, including the
occurrence data, environmental variables, and more.</p>
<p>Printed example for one species using spp[[curSp()]]:</p>
<pre><code>.  Chrysocyon_brachyurus = list 12
. .  occs = list 34 ( data.frame )
. . .  ...   and 22 more
. .  occData = list 2
. .  rmm = list 8( list RMM )
. .  rmd = list 0
. .  envs = character 1= wcbc 
. .  polySelXY = double 10= named array 5 X 2= -78.369 -76.26 -36.012 ...
. .  polySelID = integer 1= 2067
. .  procOccs = list 2
. .  procEnvs = list 2
. .  bg = list 32( data.frame )
. . .  ...   and 20 more
. .  bgPts = list 2( data.frame )
. .  evalOut = S4 1( ENMevaluation )</code></pre>
<p>Below is the complete list of reactive functions like
<code>curSp()</code> used internally in <em>Wallace</em> as shortcuts
that return characters (i.e., text) based on user selections.</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="85%">
</colgroup>
<thead><tr class="header">
<th align="left">shortcut</th>
<th align="left">output</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">curSp()</td>
<td align="left">selected species name</td>
</tr>
<tr class="even">
<td align="left">curMsp()</td>
<td align="left">selected species names separated by “|”</td>
</tr>
<tr class="odd">
<td align="left">allSp()</td>
<td align="left">vector of all species names</td>
</tr>
<tr class="even">
<td align="left">spIn()</td>
<td align="left">if batch on, all species names, if batch off, selected
species name</td>
</tr>
<tr class="odd">
<td align="left">curEnv()</td>
<td align="left">selected environmental variable</td>
</tr>
<tr class="even">
<td align="left">curModel()</td>
<td align="left">selected model</td>
</tr>
<tr class="odd">
<td align="left">component()</td>
<td align="left">selected component</td>
</tr>
<tr class="even">
<td align="left">module()</td>
<td align="left">selected module</td>
</tr>
</tbody>
</table>
<p>In addition, some data objects that are used often in the analysis
have special shortcut reactive functions associated with them. For
example, the occurrence data table <code>spp[[curSp()]]$occs</code> can
be accessed with the shortcut function <code>occs()</code>.
<strong>NOTE</strong>: These functions cannot be used to overwrite
entities in the list—in this case, you must use the explicit,
non-reactive reference.</p>
<p>For example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this will not work to overwrite</span></span>
<span><span class="fu">occs</span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">newDF</span></span>
<span><span class="co"># this will work</span></span>
<span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">occs</span> <span class="op">&lt;-</span> <span class="va">newDF</span></span></code></pre></div>
<p>Below is the complete list of reactive functions used internally in
<em>Wallace</em> as shortcuts to return data objects based on user
selections.</p>
<table class="table">
<colgroup>
<col width="43%">
<col width="8%">
<col width="32%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="left">description</th>
<th align="left">shortcut</th>
<th align="left">long_form</th>
<th align="left">class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">occurrence locality coordinates</td>
<td align="left">occs()</td>
<td align="left">spp[[curSp()]]$occs</td>
<td align="left">data frame</td>
</tr>
<tr class="even">
<td align="left">environmental raster(s)</td>
<td align="left">envs()</td>
<td align="left">spp[[curSp()]]$envs</td>
<td align="left">Raster</td>
</tr>
<tr class="odd">
<td align="left">background locality coordinates</td>
<td align="left">bg()</td>
<td align="left">spp[[curSp()]]$bg</td>
<td align="left">matrix</td>
</tr>
<tr class="even">
<td align="left">background extent polygon</td>
<td align="left">bgExt()</td>
<td align="left">spp[[curSp()]]$procEnvs$bgExt</td>
<td align="left">SpatialPolygons</td>
</tr>
<tr class="odd">
<td align="left">environmental raster(s) masked to background
extent</td>
<td align="left">bgMask()</td>
<td align="left">spp[[curSp()]]$procEnvs$bgMask</td>
<td align="left">Raster</td>
</tr>
<tr class="even">
<td align="left">ENMeval results table</td>
<td align="left">evalOut()</td>
<td align="left">spp[[curSp()]]$results</td>
<td align="left">data frame</td>
</tr>
<tr class="odd">
<td align="left">model prediction raster</td>
<td align="left">mapPred()</td>
<td align="left">spp[[curSp()]]$visualization$mapPred</td>
<td align="left">Raster</td>
</tr>
<tr class="even">
<td align="left">model transfer raster</td>
<td align="left">mapXfer()</td>
<td align="left">spp[[curSp()]]$transfer$mapXfer</td>
<td align="left">Raster</td>
</tr>
<tr class="odd">
<td align="left">metadata</td>
<td align="left">rmm()</td>
<td align="left">spp[[curSp()]]$rmm</td>
<td align="left">rangeModelMetadata</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="module-addition">Module addition<a class="anchor" aria-label="anchor" href="#module-addition"></a>
</h2>
<p>There are seven necessary steps to adding a module:</p>
<ol style="list-style-type: decimal">
<li>Define an ID for the new module.<br>
</li>
<li>Write an R function.<br>
</li>
<li>Create a <code>shiny</code> module template using
<code><a href="../reference/create_module.html">wallace::create_module()</a></code>, which creates the four files
<em>.yml, </em>.R, <em>.md, and </em>.RMD (the asterisk will be replaced
by the module ID given when creating the template)</li>
<li>Modify the *.yml file to define internal parameters in Wallace. For
example; the titles, authors, package used, and more importantly, the
component in where your new module will be placed.</li>
<li>Add source code to the *.R file to display your module’s controls
and implement its functionality.<br>
</li>
<li>Fill the *.Rmd with guidance text for your module.</li>
<li>
<em>Optional:</em> Add session code to be incorporate in markdown to
reproduce analysis in an R environment.</li>
<li>Tell the Wallace app to use your new module.</li>
</ol>
<p><img src="vignette_img/module-addition.png" width="800px" style="display: block; margin: auto;"></p>
<p>The example module we will describe calculates pairwise Pearson’s
correlation coefficients for all environmental data, and will be added
to the existing Process Environmental Data (penvs) component.</p>
<div class="section level3">
<h3 id="step-1-define-id">Step 1: Define ID<a class="anchor" aria-label="anchor" href="#step-1-define-id"></a>
</h3>
<p>First, we must define an ID for the new module. This ID must be
unique (there cannot be two modules with the same ID) and can only
contain English letters, digits, and underscores.</p>
<p>New module IDs should begin with the short name for its component
(e.g., “vis” for “Visualize”; see table below), followed by an
underscore and a unique module short name.</p>
<table class="table">
<thead><tr class="header">
<th>Component</th>
<th>Short Name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Obtain Occurrence Data</td>
<td>occs</td>
</tr>
<tr class="even">
<td>Obtain Environmental Data</td>
<td>envs</td>
</tr>
<tr class="odd">
<td>Process Occurrence Data</td>
<td>poccs</td>
</tr>
<tr class="even">
<td>Process Environmental Data</td>
<td>penvs</td>
</tr>
<tr class="odd">
<td>Characterize Environmental Space</td>
<td>espace</td>
</tr>
<tr class="even">
<td>Partition Occurrence Data</td>
<td>part</td>
</tr>
<tr class="odd">
<td>Build and Evaluate Niche Model</td>
<td>model</td>
</tr>
<tr class="even">
<td>Visualize Model Results</td>
<td>vis</td>
</tr>
<tr class="odd">
<td>Transfer Model</td>
<td>xfer</td>
</tr>
<tr class="even">
<td>Reproduce</td>
<td>rep</td>
</tr>
</tbody>
</table>
<p>Examples of existing module names are occs_queryDb for the Obtain
Occurrence Data component and the Query Database module, and
poccs_thinOccs for the Process Occurrence Data component and the Spatial
Thin module. The complete list can be found in the folder
/wallace/inst/shiny/modules.</p>
<p>We will name this module “penvs_correlations”.</p>
</div>
<div class="section level3">
<h3 id="step-2-write-an-r-function">Step 2: Write an R function<a class="anchor" aria-label="anchor" href="#step-2-write-an-r-function"></a>
</h3>
<p>Let’s write a function that carries out the module’s analysis. For
this simple example, we will print a matrix of pairwise Pearson’s
correlation coefficients for all environmental data. To calculate
Pearson correlations among rasters, we will call the
<code>layerStats()</code> function from the <strong>raster</strong>
package (Hijmans &amp; van Etten, 2012). This function takes the
following inputs: 1) RasterStack of environmental data and 2) a
statistic to compute (here we will use Pearson’s correlation
coefficient). We will then write a module function to call the
<code>layerStats()</code> function within the <em>Wallace</em>
session.</p>
<p>This function has arguments for the 1) environmental rasterStack
masked by the background extent (bgMask), 2) the name of the species
(spN), and 3) logger, a reactive value object that holds all the text
and HTML formatting for the log window. Reactive variables such as
logger can only be used within reactive contexts – they will not work
for regular R functions. When this function is run internally, the
argument “logger” should be set to the reactive value object
<code>logger</code>, which will get updated with the messages produced
by our module function. This sends messages entered with
<code><a href="../reference/writeLog.html">writeLog()</a></code> to the <em>Wallace</em> log window. The function
<code><a href="../reference/smartProgress.html">smartProgress()</a></code> will generate a shiny progress bar in the
lower-right corner of the interface that tracks the progress of the
<code>layerStats()</code> function. If the module function is run
outside of a <em>Wallace</em> session, the argument “logger” should be
left at the default NULL, which will make <code><a href="../reference/writeLog.html">writeLog()</a></code> and
<code><a href="../reference/smartProgress.html">smartProgress()</a></code> print messages and progress bars to the R
console, respectively. Additionally, hlSpp() is a function that will
highlight the printed text in bold green. This function should be used
as the first parameter for writeLog() to highlight the printed species
name (e.g., “Canis lupus | …Your message here…”).</p>
<p>Open a new R Script and write the module function as written below.
This is a basic R function with some <em>Wallace</em> functionality that
gets saved into the <code>/R</code> directory with the other package
functions. Do not forget to document your function following basic
<a href="https://cran.r-project.org/web/packages/roxygen2/vignettes/rd.html" target="_blank" class="external-link">roxygen</a>
structure with <code>@export</code> at the end, as we will need to
include reference to this function in the NAMESPACE. Save the code below
as <code>wallace/R/penvs_correlations.R</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title penvs_correlations</span></span>
<span><span class="co">#' @description Runs Pearson correlations between variable pairs</span></span>
<span><span class="co">#' @param bgMask Environmental rasters for study region.</span></span>
<span><span class="co">#' @param spN Species' name for log window.</span></span>
<span><span class="co">#' @param logger Reactive values list of log window text.</span></span>
<span><span class="co">#’ @details Any additional details needed.</span></span>
<span><span class="co">#' @return A data frame</span></span>
<span><span class="co">#' @author Juan Perez</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span></span>
<span><span class="va">penvs_correlations</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">bgMask</span>, <span class="va">spN</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">logger</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/smartProgress.html">smartProgress</a></span><span class="op">(</span><span class="va">logger</span>, </span>
<span>                message <span class="op">=</span> <span class="st">"Calculating pairwise Pearson's correlations"</span>, <span class="op">{</span></span>
<span>                  <span class="va">envCorrs</span> <span class="op">&lt;-</span> <span class="fu">layerStats</span><span class="op">(</span><span class="va">bgMask</span>, </span>
<span>                                         stat <span class="op">=</span> <span class="st">"pearson"</span>, </span>
<span>                                         na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>                <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">logger</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/writeLog.html">writeLog</a></span><span class="op">(</span><span class="fu"><a href="../reference/hlSpp.html">hlSpp</a></span><span class="op">(</span><span class="va">spN</span><span class="op">)</span>, <span class="st">"Pearson complete"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">envCorrs</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In the case that your function becomes too long or has many nested
functions, you can write auxiliary (helper) functions in the same file
(see <code>wallace/R/envs_ecoClimate.R</code> for an example).</p>
<p>Once your module function is finished, we will add it to the package
NAMESPACE by running <code>devtools::document()</code> or by pressing
<code>Ctrl/Cmd + Shift + D</code> in Rstudio. Finally, load the function
using <code>devtools::load_all()</code>.</p>
</div>
<div class="section level3">
<h3 id="step-3-create-a-shiny-module-with-create_module">Step 3: Create a shiny module with create_module()<a class="anchor" aria-label="anchor" href="#step-3-create-a-shiny-module-with-create_module"></a>
</h3>
<p>We have just specified the functionality for the module, an .R script
that goes in the <code>/R</code> folder, and now we will specify the
module’s structure in several files that go in the
<code>/inst/shiny/custom_modules</code> folder. <em>Wallace</em> modules
depend on several files: <code>*.yml</code>, <code>*.md</code>,
<code>*.R</code>, and optionally <code>*.Rmd</code>. To generate
templates for these files, run <code><a href="../reference/create_module.html">wallace::create_module()</a></code> ,
then fill the arguments in as follows:</p>
<ul>
<li>id (string): It is the module name. You will use
“penvs_correlations” here.</li>
<li>dir (string): Folder path in which your module will be saved. You
will use “./inst/shiny/custom_modules”</li>
<li>result (boolean): TRUE for this example. TRUE if the module should
support showing information in the Result tab. See more in Step 5,
option <em>iii</em>.</li>
<li>map (boolean): FALSE for this example. TRUE if the module should
support modifying the map. See more in Step 5, option <em>iv</em>.</li>
<li>save (boolean): FALSE for this example. TRUE if the module saves
custom data when the user saves the current session. See more in Step 5,
option <em>v</em>.</li>
<li>rmd (boolean): FALSE for this example. TRUE if the module should add
Rmd code to the Session Code. See more in Step 7.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">wallace</span><span class="fu">::</span><span class="fu"><a href="../reference/create_module.html">create_module</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"penvs_correlations"</span>, </span>
<span>dir <span class="op">=</span> <span class="st">"./inst/shiny/custom_modules"</span>, </span>
<span>map <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>result <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>rmd <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>save <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Four new files will be created in the <code>./custom_modules</code>
directory: penvs_correlations.yml, penvs_correlations.md,
penvs_correlations.R, and optionally penvs_correlations.Rmd.</p>
</div>
<div class="section level3">
<h3 id="step-4-modify-yaml-to-internal-module-calling">Step 4: Modify YAML to internal module calling<a class="anchor" aria-label="anchor" href="#step-4-modify-yaml-to-internal-module-calling"></a>
</h3>
<p>Open the YAML file <code>penvs_correlations.yml</code> and set the
following parameters:</p>
<ul>
<li>component: Which component this module belongs to (one of: occs,
envs, poccs, penvs, espace, part, model, vis, xfer)</li>
<li>short_name: The label to show beside the radio button in the
component’s UI</li>
<li>long_name: A longer name for the module, to show as the title in the
UI</li>
<li>authors: The author(s) of this module</li>
<li>package: The R package that is used by this module (if more than
one, use a comma between them)</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>component<span class="sc">:</span> <span class="st">"penvs"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>short_name<span class="sc">:</span> <span class="st">"Pearson's correlations"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>long_name<span class="sc">:</span> <span class="st">"Calculate pairwise Pearson's correlations between environmental layers"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>authors<span class="sc">:</span> <span class="st">"Peter Galante"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>package<span class="sc">:</span> [raster]</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-5-module-controls-and-functionality">Step 5: Module controls and functionality<a class="anchor" aria-label="anchor" href="#step-5-module-controls-and-functionality"></a>
</h3>
<p>Aside from the .R file in <code>/R</code> directory, you also need to
have an .R file named <code>penvs_correlations.R</code> that specifies
the controls and how the module function is run in the same directory as
the YAML file. This R file contains 3 main parts and 3 optional
ones:</p>
<ol style="list-style-type: lower-roman">
<li>A function named <code>penvs_correlations_module_ui</code> returns
the user interface (UI) for this module, which includes the controls
that the user interacts with to input module parameters and run
functions. This function should follow the conventions for general Shiny
modules—it should take a single argument called “id”, use it to create a
unique namespace for the module, and return a list of UI objects.
Usually, there should at least be a button that runs the module
function. Shiny modules operate in their own unique namespaces, and so
use of the <code><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS()</a></code> function is necessary to ensure the
module’s UI controls can talk to <code>ui.R</code>. The function
<code>ns()</code> (for namespace), returned from <code>NS(id)</code>, is
run on the ID names of shiny UI input elements, as in
<code>numericInput(ns("degFr"), ...)</code>, to enable this connection
to <code>ui.R</code>. See the
<a href="https://shiny.rstudio.com/articles/modules.html" target="_blank" class="external-link">shiny
module vignette</a> for more details.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penvs_correlations_module_ui</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/tagList.html" class="external-link">tagList</a></span><span class="op">(</span></span>
<span>    <span class="co"># UI</span></span>
<span>    <span class="co">## Add a checkbox for batch processing (more than 1 species)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/checkboxInput.html" class="external-link">checkboxInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, label <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">strong</a></span><span class="op">(</span><span class="st">"Batch"</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="co">## Give the action button a name and a label.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html" class="external-link">actionButton</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"runCorrs"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"Calculate correlations"</span><span class="op">)</span>,</span>
<span>    <span class="co">## UI for reselecting variables after calculating correlations. This custom input one will create in the server module function</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">uiOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"VarSelect"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="co">## UI button to select variables to be used in the analysis.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html" class="external-link">actionButton</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"selectConfirm"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"Select Variables"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ol start="2" style="list-style-type: lower-roman">
<li>A function named <code>penvs_correlations_module_server</code> that
defines the server functionality for this module. This function should
follow the conventions for general Shiny modules— it should take
arguments <code>input</code>, <code>output</code>, and
<code>session</code>, as well as one extra argument
<code>common</code>.</li>
</ol>
<p>The <code>common</code> variable supplied to a module’s server
function (and map function, explained later) is a list containing: The
following reactive variables that can be used by the module: logger,
spp, curSp, allSp, curEnv, curModel, component, module, envs.global,
mapCntr. The following reactives that are shortcuts to reactives inside
spp: occs, envs, bg, bgExt, bgMask, evalOut, mapPred, mapXfer, rmm. A
function <code>update_component(tab)</code> that allows you to switch to
a new tab within the component.</p>
<p>This function <code>penvs_correlations_module_server()</code> is a
wrapper for a shiny reactive expression. Inside, there is a template for
the essential parts needed in a <em>Wallace</em> module. First, we
specify shorter names for the shortcut variables inside the “common”
list. Next, we specify a UI function that can use reactive values inside
of this server function—in this case, we want to know the names of the
environmental variables input so they can be printed to the UI control
(see Creating a reactive shortcut in the next section for more details).
After this, we specify when the module function gets run. The function
<code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent()</a></code> performs an action in response to an event
(e.g., clicking a button created by
<code>penvs_correlations_module_ui()</code>). Inside of each
<code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent()</a></code>, you need to include the following code. The
first, “WARNING”, catches any possible errors before the module’s core
functionality is run. If there is an error, the function stops and a log
error message is written. The user will need to define these errors in
order to catch them and prevent the module from crashing unexpectedly.
Next, under “FUNCTION CALL”, we call the function from
<code>/wallace/R</code> and make sure it returns what we expect. Next,
under “LOAD INTO SPP”, we load the model object into <code>spp</code>.
Finally, under “METADATA”, we fill in appropriate metadata fields for
the rangeModelMetadata object in <code>spp</code>. Ultimately, the
module author decides what metadata to include, but we encourage authors
to explore the rangeModelMetadata object, decide which fields best apply
to your module, and enter information detailed enough to enable
reproducibility. As shiny modules exist in their own namespaces, if we
want to refer to any of the results from the module later (in other
modules), we need to put them into the <code>spp</code> reactiveValues
list.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penvs_correlations_module_server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span>, <span class="va">common</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Define common objects that will be used in this function</span></span>
<span>  <span class="va">logger</span> <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">logger</span></span>
<span>  <span class="va">spp</span>    <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">spp</span></span>
<span>  <span class="va">allSp</span>  <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">allSp</span></span>
<span>  <span class="va">curSp</span>  <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">curSp</span></span>
<span>  <span class="va">bgMask</span> <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">bgMask</span> <span class="co"># raster stack after masking by background</span></span>
<span>  <span class="va">VarSelector</span> <span class="op">&lt;-</span> <span class="va">common</span><span class="op">$</span><span class="va">VarSelector</span> <span class="co"># See how to create and include a reactive shortcut later in the main text.</span></span>
<span></span>
<span>  <span class="co"># Create a custom UI input</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">VarSelect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderUI.html" class="external-link">renderUI</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">shinyWidgets</span><span class="fu">::</span><span class="fu"><a href="https://dreamrs.github.io/shinyWidgets/reference/pickerInput.html" class="external-link">pickerInput</a></span><span class="op">(</span></span>
<span>      <span class="st">"VarSelector"</span>,</span>
<span>      label <span class="op">=</span> <span class="st">"Select variables"</span>,</span>
<span>      choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      multiple <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      selected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>`actions-box` <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## When action button defined in the ui function above is clicked, do the following:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">runCorrs</span>, <span class="op">{</span></span>
<span>     <span class="co"># WARNING ####</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">logger</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/writeLog.html">writeLog</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'error'</span>, <span class="fu"><a href="../reference/hlSpp.html">hlSpp</a></span><span class="op">(</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="st">'Background data missing. Sample study region first'</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Check that the background has already been selected</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="fu">bgMask</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>       </span>
<span>    <span class="co"># Set up if you want batch to be allowed</span></span>
<span>      <span class="co"># allSp() is the list of species selected</span></span>
<span>      <span class="co"># curSp() refers to the currently selected species in the GUI</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">batch</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="va">spLoop</span> <span class="op">&lt;-</span> <span class="fu">allSp</span><span class="op">(</span><span class="op">)</span> <span class="kw">else</span> <span class="va">spLoop</span> <span class="op">&lt;-</span> <span class="fu">curSp</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="co"># If batch is true, loop through all species (allSp())</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">sp</span> <span class="kw">in</span> <span class="va">spLoop</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># FUNCTION CALL ####</span></span>
<span>      <span class="fu"><a href="../reference/smartProgress.html">smartProgress</a></span><span class="op">(</span><span class="va">logger</span>, message <span class="op">=</span> <span class="st">"Calculating pairwise correlations"</span>, <span class="op">{</span></span>
<span>        <span class="va">envCorrs</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/layerStats.html" class="external-link">layerStats</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spp</span><span class="op">[[</span><span class="va">sp</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgMask</span>, na.rm <span class="op">=</span> <span class="cn">T</span>, stat <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>    <span class="co"># To update the log window</span></span>
<span>    <span class="va">logger</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/writeLog.html">writeLog</a></span><span class="op">(</span><span class="fu"><a href="../reference/hlSpp.html">hlSpp</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>, <span class="st">"Finished calculating correlations"</span><span class="op">)</span></span>
<span>    <span class="co">#envCorrs &lt;- raster::layerStats(x = bgMask(), na.rm = T, stat = "pearson")</span></span>
<span></span>
<span>    <span class="co"># LOAD INTO SPP ####</span></span>
<span>  <span class="va">spp</span><span class="op">[[</span><span class="va">sp</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">envCorrs</span> <span class="op">&lt;-</span> <span class="va">envCorrs</span><span class="op">$</span><span class="va">`pearson correlation coefficient`</span></span>
<span></span>
<span>    <span class="co"># METADATA ####</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Switch to Results tab to display results</span></span>
<span>  <span class="va">common</span><span class="op">$</span><span class="fu">update_component</span><span class="op">(</span>tab <span class="op">=</span> <span class="st">"Results"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Define output as a table</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">envCorrTable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html" class="external-link">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Result</span></span>
<span>    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">envCorrs</span>, format <span class="op">=</span> <span class="st">'html'</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Observe when selection is confirmed</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">selectConfirm</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/req.html" class="external-link">req</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">envCorrs</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## update bg object</span></span>
<span>    <span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgMask</span> <span class="op">&lt;-</span> <span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgMask</span><span class="op">[[</span><span class="fu">VarSelector</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Add a line to logger to identify which variables were selected</span></span>
<span>        <span class="co"># hlSpp() prints the species name in green, bold, and italics</span></span>
<span>    <span class="va">logger</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/writeLog.html">writeLog</a></span><span class="op">(</span><span class="fu"><a href="../reference/hlSpp.html">hlSpp</a></span><span class="op">(</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Selected: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgMask</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong><em>Creating a reactive shortcut</em></strong></p>
<p>The custom UI slot (“varSelector”) in the server function
(penvs_correlations_module_server) requires the names of the selected
variables that were uploaded in the previous component (e.g., WorldClim,
ecoClimate, user-specified). Because the numbers and names of the
rasters will change depending on which rasters were uploaded, we need to
create a reactive function to get their names. In addition to writing
the code to make this UI object in the server file above, we
additionally need to add two lines to the main “inst/shiny/server.R”
file.</p>
<p>The first line creates the reactive object. For organizational
purposes, reactive shortcuts should be placed with the other shortcuts
created in each component. Please add only the <em>last</em> line in the
“COMPONENT: PROCESS ENVIRONMENTAL DATA” section, which should be at line
#380.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">############################################## #</span></span>
<span>  <span class="co">### COMPONENT: PROCESS ENVIRONMENTAL DATA ####</span></span>
<span>  <span class="co">############################################## #</span></span>
<span></span>
<span>  <span class="co"># # # # # # # # # # # # # # # # # #</span></span>
<span>  <span class="co"># PROCESS ENVS: other controls ####</span></span>
<span>  <span class="co"># # # # # # # # # # # # # # # # # #</span></span>
<span></span>
<span>  <span class="co"># convenience function for background points table for current species</span></span>
<span>  <span class="va">bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">bg</span><span class="op">)</span></span>
<span>  <span class="co"># convenience function for background polygon for current species</span></span>
<span>  <span class="va">bgExt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgExt</span><span class="op">)</span></span>
<span>  <span class="co"># convenience function for environmental variable rasters masked to background for current species</span></span>
<span>  <span class="va">bgMask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="va">spp</span><span class="op">[[</span><span class="fu">curSp</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">procEnvs</span><span class="op">$</span><span class="va">bgMask</span><span class="op">)</span></span>
<span>  <span class="co"># THIS LINE WILL CREATE THE REACTIVE</span></span>
<span>  <span class="va">VarSelector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html" class="external-link">reactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">VarSelector</span><span class="op">)</span></span></code></pre></div>
<p>The second line will add the shortcut to the common list. Please
search for “COMMON LIST FUNCTIONALITY” (#1310) in the server file, and
add it to the section of “Shortcuts to values nested inside spp”.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">### COMMON LIST FUNCTIONALITY ####</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">################################</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a data structure that holds variables and functions used by modules</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  common <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reactive variables to pass on to modules</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">logger =</span> logger,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">spp =</span> spp,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">curSp =</span> curSp,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">allSp =</span> allSp,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">multSp =</span> multSp,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">curEnv =</span> curEnv,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">curModel =</span> curModel,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">component =</span> component,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">module =</span> module,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">envs.global =</span> envs.global,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapCntr =</span> mapCntr,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shortcuts to values nested inside spp</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">occs =</span> occs,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">envs =</span> envs,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcSel =</span> bcSel,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecoClimSel =</span> ecoClimSel,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg =</span> bg,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">bgExt =</span> bgExt,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">bgMask =</span> bgMask,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">bgShpXY =</span> bgShpXY,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">selCatEnvs =</span> selCatEnvs,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">evalOut =</span> evalOut,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapPred =</span> mapPred,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapXfer =</span> mapXfer,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmm =</span> rmm,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">VarSelector =</span> VarSelector, <span class="co"># ADD line here (do not forget to add a comma at the end)</span></span></code></pre></div>
<ol start="3" style="list-style-type: lower-roman">
<li>A function named <code>penvs_correlations_module_result</code> that
returns the UI output for the results of the module function (i.e.,
plot, table). Any outputs need to be rendered in the
<code>penvs_correlation_module_server</code> function, and the ID name
of these outputs are specified here (in this scenario,
output$envCorrTable). This function should also follow the same
conventions regarding module namespace as the previous functions.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penvs_correlations_module_result</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/NS.html" class="external-link">NS</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span>  <span class="co"># Result UI as html</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/htmlOutput.html" class="external-link">htmlOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"envCorrTable"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ol start="4" style="list-style-type: lower-roman">
<li><p><em>OPTIONAL:</em> A function named
<code>penvs_correlations_module_map</code> that modifies the map. This
function takes two arguments: <code>map</code> (a reference to a leaflet
map) and <code>common</code> (the same parameter from the server
function).</p></li>
<li><p><em>OPTIONAL:</em> The
<code>penvs_correlations_module_server</code> function can enable the
module to record the session information when the session is saved. This
option will be enabled when you specified the parameter save as TRUE
when using create_module(). It returns a list with two functions:
<code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> and <code>load(state)</code>. The
<code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> function takes no arguments and should return a
named list with all the variables to save. The <code>load(state)</code>
function takes one argument, which should consist of the same list of
variables that were saved.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="step-6-guidance-text-for-your-module">Step 6: Guidance text for your module<a class="anchor" aria-label="anchor" href="#step-6-guidance-text-for-your-module"></a>
</h3>
<p>The last vital step is writing guidance text for your module. This
text provides a detailed description of what your module does and where
to find more relevant information for the benefit of other users. To add
these instructions and other information for your module, you need to
edit the Markdown file <code>penvs_correlations.md</code>. Enter the
background information for the module’s analysis, any methodological
details that help users understand what the module does and why they
might want to use it, and any relevant references to the literature.
Guidance texts have three sections. BACKGROUND provides general
information about the framing of the module’s technique in the grand
scheme of things. IMPLEMENTATION describes how the technique is used in
this module. Finally, REFERENCES is a bibliography of academic sources
that are referenced in the text.</p>
<pre><code>### **Module: Pearson Correlation**

**BACKGROUND**

Calculate pairwise Pearson's product-moment variable correlations for all predictor variables. 

**IMPLEMENTATION**

After loading environmental layers select background extent and sample background points. These points are used to sample each layer to calculate correlations. Correlations are calculated for single or multiple species.

**REFERENCES**

Robert J. Hijmans (2019). raster: Geographic Data Analysis and Modeling. R package version 2.9-5.
</code></pre>
</div>
<div class="section level3">
<h3 id="step-7-session-code-to-reproduce-analysis-in-an-r-environment">Step 7: Session code to reproduce analysis in an R environment<a class="anchor" aria-label="anchor" href="#step-7-session-code-to-reproduce-analysis-in-an-r-environment"></a>
</h3>
<p><em>OPTIONAL:</em> A function named
<code>penvs_correlations_module_rmd</code> that adds code to the
“Session Code” Rmd output to enable reproducibility of your module
analysis. This function returns a list with variables that are used in
the module’s RMD code, and takes an argument <code>species</code> that
contains all the information for the current species. If you specified
the rmd parameter as TRUE in create_module() from Step 3, the file
template <code>penvs_correlations.Rmd</code> will be created in the
custom_module directory. You should add code to this RMD file to repeat
the module analysis. If you need to use any variables originally
specified by the user during the session, you can use double curly
brackets and define it inside the
<code>penvs_correlations_module_rmd</code> function. For example, in
modules/occs_queryDb.R line #169, the number of occurrences to download
from gbif (occs_queryDb module) is saved in occNum_rmd. Then, see line
#16 in modules/occs_queryDb.Rmd to find the same object with curly
brackets, {{occNum_rmd}}, is used to create the specific session code of
the module. Two variables are always made automatically available for
these RMD code chunks: <code>{{sp}}</code> is the species ID and
<code>{{spName}}</code> is the species’ scientific name. See other
module RMD files for examples in inst/shiny/modules.</p>
</div>
<div class="section level3">
<h3 id="final-step-tell-the-wallace-app-to-use-your-module">Final step: Tell the Wallace app to use your module<a class="anchor" aria-label="anchor" href="#final-step-tell-the-wallace-app-to-use-your-module"></a>
</h3>
<p>Congratulations! You finished creating your module. The final step is
to tell the <em>Wallace</em> application to use it by calling the
<code><a href="../reference/register_module.html">register_module()</a></code> function.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">wallace</span><span class="fu">::</span><span class="fu"><a href="../reference/register_module.html">register_module</a></span><span class="op">(</span><span class="st">"./inst/shiny/custom_modules/penvs_correlations.yml"</span><span class="op">)</span></span></code></pre></div>
<p>Then, you just need to open <em>Wallace</em> using
<code><a href="../reference/run_wallace.html">run_wallace()</a></code> and your new module is ready for a test
drive!</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jamie M. Kass, Gonzalo E. Pinilla-Buitrago, Andrea Paz, Bethany A. Johnson, Valentina Grisales-Betancur, Dean Attali, Matthew E. Aiello-Lammens, Cory Merow, Mary E. Blair, Robert P. Anderson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
